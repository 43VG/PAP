{% extends "homepage.html" %}  <!-- Herda a estrutura da homepage, incluindo o menu -->

{% block content %}
<div class="container">
    <h1>Bem-vindo ao Dashboard, {{ current_user.nome }}!</h1>

    {% if preview_html %}
        <!-- Mostra a tabela de preview -->
        <h3>Preview dos dados selecionados</h3>
        <div class="table-responsive">
            {{ preview_html|safe }}
        </div>

        <!-- Se칞칚o de Gr치ficos Anteriores -->
        {% if graficos_anteriores %}
            <div class="graphs-history mt-4">
                <h3>Gr치ficos Anteriores</h3>
                <div class="row">
                    {% for grafico_id, grafico_html in graficos_anteriores.items() %}
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    {{ grafico_html|safe }}
                                    <div class="mt-2">
                                        <a href="{{ url_for('rotas.exportar_grafico', grafico_id=grafico_id, formato='png') }}" class="btn btn-sm btn-secondary">游닌 Exportar como PNG</a>
                                        <a href="{{ url_for('rotas.exportar_grafico', grafico_id=grafico_id, formato='pdf') }}" class="btn btn-sm btn-secondary">游닌 Exportar como PDF</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Se칞칚o de Novo Gr치fico -->
        <div class="graph-section mt-4">
            <div class="d-flex justify-content-between align-items-center">
                <h3>Criar Novo Gr치fico</h3>
                {% if graficos_anteriores %}
                    <form action="{{ url_for('rotas.limpar_graficos') }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-danger">Limpar Todos os Gr치ficos</button>
                    </form>
                {% endif %}
            </div>
            <form action="{{ url_for('rotas.gerar_grafico') }}" method="post" class="card p-3">
                <div class="form-group mb-3">
                    <label for="coluna_x">Coluna X (Texto):</label>
                    <select class="form-control" name="coluna_x" id="coluna_x" required>
                        {% for coluna in colunas_texto %}
                            <option value="{{ coluna }}">{{ coluna }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label for="coluna_y">Coluna Y (Num칠rica):</label>
                    <select class="form-control" name="coluna_y" id="coluna_y" required>
                        {% for coluna in colunas_numericas %}
                            <option value="{{ coluna }}">{{ coluna }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group mb-3">
                    <label>Tipos de Gr치ficos:</label><br>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="tipos_graficos" value="Barras" id="barras">
                        <label class="form-check-label" for="barras">Barras</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="tipos_graficos" value="Linhas" id="linhas">
                        <label class="form-check-label" for="linhas">Linhas</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="tipos_graficos" value="Pizza" id="pizza">
                        <label class="form-check-label" for="pizza">Pizza</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Criar Novo Gr치fico</button>
            </form>
        </div>

        <!-- Se칞칚o de Gr치ficos Rec칠m-Criados -->
        {% if graficos %}
            <div class="graphs-container mt-4">
                <h3>Gr치ficos Rec칠m-Criados</h3>
                <div class="row">
                    {% for grafico_id, grafico_info in graficos.items() %}
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4>Gr치fico de {{ grafico_info.tipo }}</h4>
                                    <p class="text-muted">{{ grafico_info.coluna_y }} por {{ grafico_info.coluna_x }}</p>
                                    {{ grafico_info.html|safe }}
                                    <div class="mt-2">
                                        <a href="{{ url_for('rotas.exportar_grafico', grafico_id=grafico_id, formato='png') }}" class="btn btn-sm btn-secondary">游닌 Exportar como PNG</a>
                                        <a href="{{ url_for('rotas.exportar_grafico', grafico_id=grafico_id, formato='pdf') }}" class="btn btn-sm btn-secondary">游닌 Exportar como PDF</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

    {% elif folhas_por_ficheiro %}
        <hr>
        <!-- Formul치rio para sele칞칚o das folhas desejadas de cada ficheiro -->
        <form action="{{ url_for('rotas.selecionar_folhas') }}" method="post">
            <h3>Selecione as folhas que quer usar:</h3>
            {% for nome, folhas in folhas_por_ficheiro.items() %}
                <strong>{{ nome }}</strong><br>
                {% for folha in folhas %}
                    <input type="checkbox" name="selecionadas_{{ nome }}" value="{{ folha }}" checked>
                    {{ folha }}<br>
                {% endfor %}
                <br>
            {% endfor %}

            {% for nome in folhas_por_ficheiro %}
                <input type="hidden" name="ficheiros_nome" value="{{ nome }}">
            {% endfor %}

            <button type="submit" class="btn btn-primary">Confirmar folhas</button>
        </form>

    {% else %}
        <!-- Formul치rio para upload de m칰ltiplos ficheiros Excel -->
        <form action="{{ url_for('rotas.upload_excel') }}" method="post" enctype="multipart/form-data">
            <label for="ficheiros">Seleciona ficheiros Excel:</label><br>
            <input type="file" name="ficheiros" multiple required class="form-control"><br><br>
            <button type="submit" class="btn btn-primary">Carregar ficheiros</button>
        </form>
    {% endif %}
</div>

<!-- Adiciona Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}
